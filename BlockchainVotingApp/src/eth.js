import { Promise } from "q";

var BlockPoll = {
    abi: [{ "constant": true, "inputs": [{ "name": "_index", "type": "uint256" }], "name": "getPollItemFromPoll", "outputs": [{ "name": "", "type": "string" }, { "name": "", "type": "uint8" }], "payable": false, "stateMutability": "view", "type": "function" }, { "constant": true, "inputs": [], "name": "getPollData", "outputs": [{ "name": "pollName", "type": "string" }, { "name": "creator", "type": "address" }, { "name": "active", "type": "bool" }, { "name": "close", "type": "bool" }, { "name": "totalVotes", "type": "uint256" }, { "name": "alreadyVoted", "type": "bool" }, { "name": "creationDate", "type": "uint256" }, { "name": "finishDate", "type": "uint256" }, { "name": "items", "type": "uint256" }], "payable": false, "stateMutability": "view", "type": "function" }, { "constant": false, "inputs": [], "name": "setActive", "outputs": [], "payable": false, "stateMutability": "nonpayable", "type": "function" }, { "constant": false, "inputs": [{ "name": "_namePollItem", "type": "string" }], "name": "addPollItem", "outputs": [], "payable": false, "stateMutability": "nonpayable", "type": "function" }, { "constant": false, "inputs": [], "name": "closePoll", "outputs": [], "payable": false, "stateMutability": "nonpayable", "type": "function" }, { "constant": false, "inputs": [{ "name": "_pollItemToVote", "type": "string" }], "name": "vote", "outputs": [], "payable": false, "stateMutability": "nonpayable", "type": "function" }, { "inputs": [{ "name": "_name", "type": "string" }, { "name": "_endDate", "type": "uint256" }], "payable": false, "stateMutability": "nonpayable", "type": "constructor" }],
    contractInstance: undefined,
    deployContract: function (_name, _endDate) {
        var votingContract = window.web3.eth.contract(this.abi);
        votingContract.new(
            _name,
            _endDate,
            {
                from: window.web3.eth.accounts[0],
                data: '0x608060405234801561001057600080fd5b506040516111e43803806111e4833981018060405281019080805182019291906020018051906020019092919050505060e0604051908101604052808381526020013373ffffffffffffffffffffffffffffffffffffffff16815260200160008152602001428152602001828152602001600015158152602001600015158152506000808201518160000190805190602001906100ae92919061015e565b5060208201518160010160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555060408201518160020155606082015181600301556080820151816004015560a08201518160050160006101000a81548160ff02191690831515021790555060c08201518160050160016101000a81548160ff0219169083151502179055509050505050610203565b828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f1061019f57805160ff19168380011785556101cd565b828001600101855582156101cd579182015b828111156101cc5782518255916020019190600101906101b1565b5b5090506101da91906101de565b5090565b61020091905b808211156101fc5760008160009055506001016101e4565b5090565b90565b610fd2806102126000396000f300608060405260043610610078576000357c0100000000000000000000000000000000000000000000000000000000900463ffffffff1680630c26be3e1461007d57806348bb06cc14610130578063760a8c2a14610230578063a02ee90914610247578063ed8c2aed146102b0578063fc36e15b146102c7575b600080fd5b34801561008957600080fd5b506100a860048036038101908080359060200190929190505050610330565b60405180806020018360ff1660ff168152602001828103825284818151815260200191508051906020019080838360005b838110156100f45780820151818401526020810190506100d9565b50505050905090810190601f1680156101215780820380516001836020036101000a031916815260200191505b50935050505060405180910390f35b34801561013c57600080fd5b506101456104a8565b60405180806020018a73ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200189151515158152602001881515151581526020018781526020018615151515815260200185815260200184815260200183815260200182810382528b818151815260200191508051906020019080838360005b838110156101ed5780820151818401526020810190506101d2565b50505050905090810190601f16801561021a5780820380516001836020036101000a031916815260200191505b509a505050505050505050505060405180910390f35b34801561023c57600080fd5b50610245610624565b005b34801561025357600080fd5b506102ae600480360381019080803590602001908201803590602001908080601f0160208091040260200160405190810160405280939291908181526020018383808284378201915050505050509192919290505050610795565b005b3480156102bc57600080fd5b506102c5610a15565b005b3480156102d357600080fd5b5061032e600480360381019080803590602001908201803590602001908080601f0160208091040260200160405190810160405280939291908181526020018383808284378201915050505050509192919290505050610b1a565b005b6060600061033c610e64565b600660078581548110151561034d57fe5b9060005260206000200160405180828054600181600116156101000203166002900480156103b25780601f106103905761010080835404028352918201916103b2565b820191906000526020600020905b81548152906001019060200180831161039e575b50509150509081526020016040518091039020604080519081016040529081600082018054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156104695780601f1061043e57610100808354040283529160200191610469565b820191906000526020600020905b81548152906001019060200180831161044c57829003601f168201915b505050505081526020016001820160009054906101000a900460ff1660ff1660ff16815250509050806000015181602001518191509250925050915091565b606060008060008060008060008060008001600060010160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff16600060050160009054906101000a900460ff16600060050160019054906101000a900460ff16600060020154600860003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060009054906101000a900460ff16600060030154600060040154600780549050888054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156106005780601f106105d557610100808354040283529160200191610600565b820191906000526020600020905b8154815290600101906020018083116105e357829003601f168201915b50505050509850985098509850985098509850985098509850909192939495969798565b600060010160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff161415156106ec576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040180806020018281038252600e8152602001807f4e6f7420417574686f72697a656400000000000000000000000000000000000081525060200191505060405180910390fd5b6103e86000600401548115156106fe57fe5b0442101515610775576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040180806020018281038252601c8152602001807f46696e697368206461746520686173206265656e20726561636865640000000081525060200191505060405180910390fd5b6001600060050160006101000a81548160ff021916908315150217905550565b61079d610e64565b600060050160009054906101000a900460ff1615801561080d5750600060010160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff16145b1515610881576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040180806020018281038252600e8152602001807f4e6f7420417574686f72697a656400000000000000000000000000000000000081525060200191505060405180910390fd5b6103e860006004015481151561089357fe5b044210151561090a576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040180806020018281038252601c8152602001807f46696e697368206461746520686173206265656e20726561636865640000000081525060200191505060405180910390fd5b6040805190810160405280838152602001600060ff168152509050806006836040518082805190602001908083835b60208310151561095e5780518252602082019150602081019050602083039250610939565b6001836020036101000a038019825116818451168082178552505050505050905001915050908152602001604051809103902060008201518160000190805190602001906109ad929190610e81565b5060208201518160010160006101000a81548160ff021916908360ff1602179055509050506007829080600181540180825580915050906001820390600052602060002001600090919290919091509080519060200190610a0f929190610f01565b50505050565b600060010160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff16141515610add576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040180806020018281038252600e8152602001807f4e6f7420417574686f72697a656400000000000000000000000000000000000081525060200191505060405180910390fd5b60008060050160006101000a81548160ff0219169083151502179055506001600060050160016101000a81548160ff021916908315150217905550565b600060050160009054906101000a900460ff161515610ba1576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040180806020018281038252600a8152602001807f4e6f74204163746976650000000000000000000000000000000000000000000081525060200191505060405180910390fd5b6103e8600060040154811515610bb357fe5b0442101515610c2a576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040180806020018281038252601c8152602001807f46696e697368206461746520686173206265656e20726561636865640000000081525060200191505060405180910390fd5b60001515600860003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060009054906101000a900460ff161515141515610cf2576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825260158152602001807f596f75206861766520616c726561647920766f7465000000000000000000000081525060200191505060405180910390fd5b60016006826040518082805190602001908083835b602083101515610d2c5780518252602082019150602081019050602083039250610d07565b6001836020036101000a038019825116818451168082178552505050505050905001915050908152602001604051809103902060010160009054906101000a900460ff16016006826040518082805190602001908083835b602083101515610da95780518252602082019150602081019050602083039250610d84565b6001836020036101000a038019825116818451168082178552505050505050905001915050908152602001604051809103902060010160006101000a81548160ff021916908360ff1602179055506001600860003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060006101000a81548160ff02191690831515021790555060016000600201540160006002018190555050565b604080519081016040528060608152602001600060ff1681525090565b828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f10610ec257805160ff1916838001178555610ef0565b82800160010185558215610ef0579182015b82811115610eef578251825591602001919060010190610ed4565b5b509050610efd9190610f81565b5090565b828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f10610f4257805160ff1916838001178555610f70565b82800160010185558215610f70579182015b82811115610f6f578251825591602001919060010190610f54565b5b509050610f7d9190610f81565b5090565b610fa391905b80821115610f9f576000816000905550600101610f87565b5090565b905600a165627a7a72305820273f7e143ab621023531c5d865760e1bead8d659f6d5f2bca72f5dcc6edce0b90029',
                gas: '4700000'
            }, function (e, contract) {
                if (typeof contract.address !== 'undefined') {
                    window.instanceVue.contractDeployed(contract);
                }
            });
    },
    async getContract(contractAddress) {
        var contract = window.web3.eth.contract(this.abi);
        return await contract.at(contractAddress);
    },
    async addPollItem(contract, pollItemName) {
        return await new Promise(function (resolve, reject) {
            contract.addPollItem.sendTransaction(pollItemName, function (error, result) {
                if (!error) {
                    resolve(result);
                }
                else {
                    reject(error);
                }
            });
        });
    },
    async getPollData(contract) {
        return await new Promise(function (resolve, reject) {
            contract.getPollData(function (error, result) {
                if (!error) {
                    resolve(result);
                }
                else {
                    reject(error);
                }
            });
        });
    },
    async getPollItemFromPoll(contract, index) {
        return await new Promise(function (resolve, reject) {
            contract.getPollItemFromPoll(index, function (error, result) {
                if (!error) {
                    resolve(result);
                }
                else {
                    reject(error);
                }
            });
        });
    },
    async vote(contract, name) {
        return await new Promise(function (resolve, reject) {
            contract.vote(name, function (error, result) {
                if (!error) {
                    resolve(result);
                }
                else {
                    reject(error);
                }
            });
        });
    },
    async setActive(contract) {
        return await new Promise(function (resolve, reject) {
            contract.setActive(function (error, result) {
                if (!error) {
                    resolve(result);
                }
                else {
                    reject(error);
                }
            });
        });
    },
    async closePoll(contract) {
        return await new Promise(function (resolve, reject) {
            contract.closePoll(function (error, result) {
                if (!error) {
                    resolve(result);
                }
                else {
                    reject(error);
                }
            });
        });
    },
    async getTransactionReceiptMined(txHash) {
        return await new Promise(function (resolve, reject) {
            var receiptFunc = function () {
                window.web3.eth.getTransactionReceipt(txHash, function (err, res) {
                    if (res == null) {
                        setTimeout(function () { receiptFunc(); }, 500);
                    } else if (res != null) {
                        resolve(res);
                    } else if (!err) {
                        reject(err);
                    }
                });
            }
            setTimeout(function () { receiptFunc(); }, 500);
        });
    },
    async parsePollData(contract, data) {
        return await new Promise(function (resolve, reject) {
            var pollData = {
                pollName: data[0],
                creator: data[1],
                active: data[2],
                close: data[3],
                totalVotes: parseInt(data[4].toString()),
                alreadyVoted: data[5],
                creationDate: new Date(parseInt(data[6].toString()) * 1000),
                finishDate: new Date(parseInt(data[7].toString())),
                pollItems: []
            };

            var nbPollItems = parseInt(data[8].toString());
            for (var i = 0; i < nbPollItems; i++) {
                BlockPoll.getPollItemFromPoll(contract, i).then(function (result) {
                    var pollItem = BlockPoll.parsePollItem(result);
                    pollData.pollItems.push(pollItem);
                }).catch(function (error) {
                    // eslint-disable-next-line
                    reject(error);
                });
            }
            resolve(pollData);
        });
    },
    parsePollItem(data, i) {
        return {
            name: data[0],
            votes: parseInt(data[1].toString())
        };
    },
    checkIfWeb3IsInWindow() {
        return typeof window.web3 !== 'undefined' ? true : false;
    }
};

export default BlockPoll;